<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Copilot Adoption Leaderboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg-deep: #040a18;
      --bg-surface: rgba(8, 22, 48, 0.85);
      --bg-elevated: rgba(12, 30, 60, 0.9);
      --border-dim: rgba(255, 255, 255, 0.04);
      --border-subtle: rgba(100, 160, 255, 0.1);
      --border-accent: rgba(100, 180, 255, 0.25);
      --white: #ffffff;
      --cyan: #5cb8ff;
      --cyan-bright: #7dcfff;
      --green: #34d399;
      --red: #f87171;
      --gold: #fbbf24;
      --bronze: #f59e0b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Chakra Petch', sans-serif;
      background: var(--bg-deep);
      color: var(--white);
      min-height: 100vh;
    }

    .container {
      max-width: 880px;
      margin: 0 auto;
      padding: 48px 20px 80px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header-title {
      font-size: 48px;
      font-weight: 700;
    }

    .header-meta {
      font-family: 'IBM Plex Mono', monospace;
      color: var(--white);
      margin-top: 12px;
    }

    .goal-label,
    .goal-numbers,
    .goal-numbers strong,
    .board-head,
    .r-badge,
    .name-text,
    .prompts-cell,
    .trend-cell,
    .trend-up,
    .trend-down,
    .trend-flat {
      color: var(--white) !important;
    }

    .board {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      overflow: hidden;
    }

    .board-head {
      display: grid;
      grid-template-columns: 60px 1fr 100px 90px;
      padding: 14px 24px;
      background: var(--bg-elevated);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .board-row {
      display: grid;
      grid-template-columns: 60px 1fr 100px 90px;
      padding: 0 24px;
      align-items: center;
      height: 60px;
      border-bottom: 1px solid var(--border-dim);
    }

    .prompts-cell {
      text-align: right;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 16px;
      font-weight: 600;
    }

    .trend-cell {
      text-align: right;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
    }

    .footer {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1 class="header-title">Copilot Adoption Leaderboard</h1>
      <div class="header-meta">
        <span id="weekLabel">—</span>
      </div>
    </header>

    <section class="goal-section" id="goalSection" style="display:none;">
      <div class="goal-card" id="goalCard">
        <div class="goal-header">
          <span class="goal-label">Team Weekly Target</span>
          <span class="goal-numbers">
            <strong id="goalCurrent">0</strong> / <span id="goalTarget">1,000</span>
          </span>
        </div>
        <div class="goal-track">
          <div class="goal-fill" id="goalFill" style="width:0%"></div>
        </div>
      </div>
    </section>

    <section class="board-section">
      <div class="board">
        <div class="board-head">
          <span>Rank</span>
          <span>Name</span>
          <span>Prompts</span>
          <span>Trend</span>
        </div>
        <div class="board-body" id="boardBody"></div>
      </div>
    </section>
  </div>

<script>
  const TEAM_GOAL = 1000;
  const SHEETS_URL = '/api/leaderboard';

  function parseDateFlexible(s) {
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function processData(rawText) {
    const parsed = Papa.parse(rawText, {
      header: true,
      skipEmptyLines: true
    });

    const rows = parsed.data || [];

    const all = rows
      .map(r => ({
        dateText: r.Date,
        dateValue: parseDateFlexible(r.Date),
        name: r.Name,
        prompts: parseInt(r.Prompts, 10) || 0
      }))
      .filter(r => r.name && r.dateValue);

    const dates = [...new Set(all.map(r => r.dateValue.getTime()))].sort((a, b) => b - a);
    const currentWeek = new Date(dates[0]);

    const current = all
      .filter(r => r.dateValue.getTime() === currentWeek.getTime())
      .sort((a, b) => b.prompts - a.prompts);

    document.getElementById('weekLabel').textContent =
      current.length ? `Date of ${current[0].dateText}` : '—';

    const totalPrompts = current.reduce((s, r) => s + r.prompts, 0);
    document.getElementById('goalSection').style.display = '';
    document.getElementById('goalCurrent').textContent = totalPrompts.toLocaleString();

    const boardBody = document.getElementById('boardBody');
    boardBody.innerHTML = '';

    current.forEach((p, i) => {
      const row = document.createElement('div');
      row.className = 'board-row';
      row.innerHTML = `
        <div class="r-badge">${i + 1}</div>
        <div class="name-text">${p.name}</div>
        <div class="prompts-cell">${p.prompts.toLocaleString()}</div>
        <div class="trend-cell">—</div>
      `;
      boardBody.appendChild(row);
    });
  }

  async function loadData() {
    const res = await fetch(SHEETS_URL, { cache: 'no-store' });
    const text = await res.text();
    processData(text);
  }

  loadData();
</script>
</body>
</html>
