<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Copilot Adoption Leaderboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg-deep: #040a18;
      --bg-surface: rgba(8, 22, 48, 0.85);
      --bg-elevated: rgba(12, 30, 60, 0.9);
      --bg-card: rgba(16, 36, 72, 0.7);
      --border-dim: rgba(255, 255, 255, 0.04);
      --border-subtle: rgba(100, 160, 255, 0.1);
      --border-accent: rgba(100, 180, 255, 0.25);
      --text-primary: #ffffff;
      --text-secondary: #ffffff;
      --text-muted: #ffffff;
      --cyan: #5cb8ff;
      --cyan-bright: #7dcfff;
      --cyan-dim: rgba(92, 184, 255, 0.12);
      --cyan-glow: rgba(92, 184, 255, 0.35);
      --green: #34d399;
      --green-dim: rgba(52, 211, 153, 0.12);
      --red: #f87171;
      --gold: #fbbf24;
      --gold-dim: rgba(251, 191, 36, 0.1);
      --gold-glow: rgba(251, 191, 36, 0.3);
      --bronze: #f59e0b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Chakra Petch', sans-serif;
      min-height: 100vh;
      color: var(--text-primary);
      overflow-x: hidden;
      background: var(--bg-deep);
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(30, 80, 180, 0.4) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 10%, rgba(20, 60, 160, 0.35) 0%, transparent 45%),
        radial-gradient(ellipse at 50% 100%, rgba(10, 40, 120, 0.3) 0%, transparent 50%),
        linear-gradient(180deg, #040a18 0%, #071a3a 40%, #0a1e42 70%, #050e24 100%);
      background-attachment: fixed;
    }

    /* FORCE WHITE HEADERS */
    .header-meta,
    .goal-label,
    .goal-numbers,
    .goal-numbers strong,
    .board-head,
    .board-head span {
      color: #ffffff !important;
    }

    .footer { display: none; }
  </style>
</head>

<body>
  <div class="bg-grid"></div>
  <div class="bg-orb bg-orb-1"></div>
  <div class="bg-orb bg-orb-2"></div>
  <div class="bg-orb bg-orb-3"></div>
  <div class="bg-scanline"></div>

  <div class="container">
    <header class="header">
      <h1 class="header-title">Copilot <span class="accent">Adoption Leaderboard</span></h1>
      <div class="header-meta"><span id="weekLabel">—</span></div>
    </header>

    <section class="goal-section" id="goalSection" style="display:none;">
      <div class="goal-card" id="goalCard">
        <div class="goal-header">
          <span class="goal-label">Team Weekly Target</span>
          <span class="goal-numbers">
            <strong id="goalCurrent">0</strong> / <span id="goalTarget">1,000</span>
          </span>
        </div>
        <div class="goal-track">
          <div class="goal-fill" id="goalFill" style="width:0%"></div>
        </div>
      </div>
    </section>

    <section class="board-section">
      <div class="board">
        <div class="board-head">
          <span>Rank</span>
          <span>Name</span>
          <span>Prompts</span>
          <span>Trend</span>
        </div>
        <div class="board-body" id="boardBody"></div>
      </div>
    </section>
  </div>

<script>
  const TEAM_GOAL = 1000;
  const SHEETS_URL = '/api/leaderboard';

  function parseDateFlexible(s) {
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function processData(rawText) {
    const parsed = Papa.parse(rawText, { header: true, skipEmptyLines: true });
    const rows = parsed.data || [];

    const all = rows
      .map(r => ({
        dateText: r.Date,
        dateValue: parseDateFlexible(r.Date),
        name: r.Name,
        prompts: parseInt(r.Prompts, 10) || 0
      }))
      .filter(r => r.name && r.dateValue);

    const dates = [...new Set(all.map(r => r.dateValue.getTime()))].sort((a, b) => b - a);
    const currentWeek = new Date(dates[0]);

    const current = all
      .filter(r => r.dateValue.getTime() === currentWeek.getTime())
      .sort((a, b) => b.prompts - a.prompts);

    document.getElementById('weekLabel').textContent =
      current.length ? `Date of ${current[0].dateText}` : '—';

    const totalPrompts = current.reduce((s, r) => s + r.prompts, 0);
    document.getElementById('goalSection').style.display = '';
    document.getElementById('goalCurrent').textContent = totalPrompts.toLocaleString();

    const boardBody = document.getElementById('boardBody');
    boardBody.innerHTML = '';

    current.forEach((p, i) => {
      const row = document.createElement('div');
      row.className = 'board-row';
      row.innerHTML = `
        <div><span class="r-badge">${i + 1}</span></div>
        <div class="name-cell"><span class="name-text">${p.name}</span></div>
        <div class="prompts-cell">${p.prompts.toLocaleString()}</div>
        <div class="trend-cell">—</div>
      `;
      boardBody.appendChild(row);
    });
  }

  async function loadData() {
    const res = await fetch(SHEETS_URL, { cache: 'no-store' });
    const text = await res.text();
    processData(text);
  }

  loadData();
</script>
</body>
</html>
